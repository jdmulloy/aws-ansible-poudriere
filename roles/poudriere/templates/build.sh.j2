#!/bin/sh

# TODO: Autostart on boot

PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin
JAILS="{{ ' '.join(jdmulloy_poudriere_environments.keys()) }}"
PROCESS_COUNT={{ ansible_processor_count }}
TIMESTAMP=$(date "+%Y-%m-%d_%H-%M")
LOG="/var/log/poudriere_${TIMESTAMP}"

# Update ports tree
/usr/local/bin/poudriere ports -u -p default

for JAIL in ${JAILS}; do
/usr/local/bin/poudriere bulk -f /usr/local/etc/poudriere.d/${JAIL}.list -j ${JAIL} -J ${PROCESS_COUNT} -p default -T
/usr/local/bin/poudriere pkgclean -f /usr/local/etc/poudriere.d/${JAIL}.list -j ${JAIL} -J ${PROCESS_COUNT} -p default >> /var/log/poudriere
done

# TODO: Upload to S3
# TODO: Send email with output

# TODO: Make shutdown robust
/sbin/shutdown -p now
